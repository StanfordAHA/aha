name: Integration Tests

on:
  push:
    branches:
      - master
    paths-ignore:
      - '**.md'
  pull_request:
    branches:
      - master
  schedule:
    - cron: '0 11 * * *'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v1
      with:
        submodules: recursive
#     - name: Build Docker Image
#       run: docker build . -t testing
#     - name: Run Integration Tests
#       run: |
#         docker run --name test --rm -it -d testing bash
#         docker exec test pip freeze
#         docker exec test aha garnet --width 4 --height 2 --verilog
#         docker exec test test -e /aha/garnet/garnet.v
    - run: /bin/false
    - name: Notify Owners
      if: github.event_name == 'pull_request' && failure()
      uses: actions/github-script@0.4.0
      with:
        github-token: ${{secrets.GITHUB_TOKEN}}
        script: |
          const creator = context.payload.sender.login
          if (!creator.includes("dependabot")) {
            // return
          }
          
          const updated_repo = context.payload.pull_request.title.match(/Bump ([^\s]+)/)[1]
          console.log(updated_repo)
          
          const result = await github.repos.getContents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: "OWNERS.json"
            })
          const owners = JSON.parse(Buffer.from(result.data.content, result.data.encoding))
          
          const assignees = owners[updated_repo].map(x => "@" + x).join(" ")
          console.log(assignees)
          
          await github.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'Oops! ' + assignees
            })
